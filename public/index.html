<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tienda Web3</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9fafb; margin: 20px; }
    h1 { color: #333; }
    button { padding: 8px 16px; background: #4f46e5; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #3730a3; }
    .product { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 12px; }
    .wallet { margin-bottom: 20px; }
  </style>
</head>
<body>
    <h1>Tienda WEB3</h1>
    <div class="wallet">
        <button id ="connectWallet">Conectar Metamask</button>
        <p id="walletAddress"></p>
    </div>

    <h2>Productos Disponibles</h2>
    <div id="productList"></div>
    <script>
        const API_URL="http://localhost:3000"
        const CONTRACT_ADDRESS="0xfD1fddBF463193BDC333c199A51D4AcE1feA6682"
        const CONTRACT_ABI=[]
        let currentAccount = null
        let provider, signer, contract
        async function connectWallet(){
            if(!window.ethereum){
                alert('Instala Metamask')
                return
            }

            provider = new ethers.providers.Web3Provider(window.ethereum)
            await provider.send("eth_requestAccounts",[])
            signer = provider.getSigner()
            currentAccount = await signer.getAddress()
            document.getElementById("walletAddress").innerText=`Conectado ${currentAccount}`
            contract = new ethers.Contract(CONTRACT_ADDRESS,CONTRACT_ABI,signer)
        }
        document.getElementById("connectWallet").onclick = connectWallet
        loadProducts()

        async function loadProducts() {
            const res = await fetch(`${API_URL}/api/wallet/products`)
            const data = await res.json()

            if (!data.success) {
                alert("Error al obtener productos")
                return
            }

            const list = document.getElementById("productList")
            list.innerHTML = ""

            data.products.forEach(p => {
                const div = document.createElement('div')
                div.className = 'product'
                div.innerHTML = `
                    <h3>${p.name}</h3>
                    <p>Precio: ${p.price} ETH</p>
                    <p>Vendedor: ${p.seller}</p>
                    <button onclick="buyProduct(${p.id}, '${p.price}')">Comprar</button>
                `
                list.appendChild(div)
            })
        }

        async function buyProduct(productId,price){
            if(!currentAccount||!contract){
                alert("Conecta tu wallet primero")
                return;
            }
            try{
                const value = ethers.utils.parseEther(price.toString())
                const tx = await contract.buyProduct(productId,{value})
                const receipt = await tx.wait();
                console.log("Compra confirmada",receipt)
                alert(`Compra realizado, TXHASH:${receipt.transactionHash}`)
            }catch(err){
                console.error("Error en la compra",err)
                alert('Error: '+err.message)
            }
        }
    </script>
</body>
</html>